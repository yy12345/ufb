<div class="body">
	<!--开始 body内容替换区域-->
	<section class="loadbody">
		<div class="container">
			<div class="boxC">
				<div class="itemD">
                	<div class="a1">学生档案管理</div>
                </div>
			</div>
			<div class="boxB">
				<div class="itemH">
                	<div class="a1 cl">
                    	<div class="common-form panel">
                            <ul class="safeInfo">
	                            <li class="totalBtn">
	                                <span class="choseClass H42">班级选择</span>
	                                <a href="javascript:;" class="all #if(!${cid})active#end">全部</a>
	                                <a href="${ufbDomain}/school/class_setting.htm" class="sz fr">年级/班级设置</a>
	                            </li>
	                            <li class="Addr zIndex">
	                                <div class="inputL"> 
	                                   <select id="grade" class="select">
	                                      <option value="0">年级（全部）</option>
	                                      #foreach($ct in $allTypes)
	                                      <option value="${ct.id}">${ct.name}</option>
	                                      #end
	                                   </select>
	                                </div>   
	                                 <div class="inputR"> 
	                                    <select id="clazz" class="select">
	                                          <option value="0">班级（全部）</option>
	                                    </select>
	                                </div>    
	                            <li class="searchBox">
	                                <span class="choseClass H55">搜索学生</span>
                                     <div class="searchDiv">
                                         <input type="text" placeholder="搜索学生姓名">
                                         <span>搜索</span>
                                     </div>
	                            </li>
	                        </ul>
	                    </div>
                    </div>
					<div class="a3">
						<div class="b1 cl">
							<a href="${ufbDomain}/school/student_detail.htm?action=add&backUrl=${ufbDomain}/school/student_adjust.htm" class="c3 floatR">+新档案</a>
							<a href="${ufbDomain}/school/student_manager.htm" class="c1">批量导入</a>
							<a href="javascript:;" class="c1 active">调班</a>
						</div>
						<div class="b2">
							<div class="cl c2 tabCon active">
								<div class="d1"><label class="checkbox"><input type="checkbox" id="classAll">全选</label></div>
								<div class="d2">
									<div class="e1">已选择<span id="studentNum">0</span>个学生，进入</div>
									<select id="toClazz" class="select">
										<option value="0">选择班级</option>
										#foreach($ct in $allTypes)
											<option disabled>${ct.name}</option>
											#foreach($c in $clazzList)
												#if(${c.typeid} == ${ct.id})<option value="${c.cid}">${c.name}</option>#end
											#end
										#end
									</select>
									<a href="javascript:;" class="btnB" id="classChange">确认调班</a>
								</div>
							</div>
						</div>
					</div>
					<div class="listStu">
						#foreach($c in $clazzList)
						<div class="a4" gradeid="${c.typeid}" cid="${c.cid}" #if(${cid} && ${c.cid}!=${cid})style="display:none"#end>
                        	<div class="b1 cl">
                            	<div class="c1">
	                            	<label class="checkbox"><input type="checkbox" name="classTop[]" value="${c.cid}">${c.name}</label>
	                            	<span class="d1">${c.size}</span><span>人</span>
                            	</div>
                                <div class="c2" data-href="${ufbDomain}/school/student_list.htm?cid=${c.cid}&module=adjust"></div>
                            </div>
                            <div class="b2"></div>
						</div>
						#end
					</div>
					<!-- listStu end  -->
                </div>
			</div>
		</div>
		<!--开始 本页面JS-->
		<script type="text/javascript">
			$('nav a:eq(1)').addClass('active');
			
			// 初始化选项框及checkbox
			$('#grade').selectMenu({change:changeGrade});
			$('#clazz').selectMenu({change:changeClazz});
			$('.checkbox').checkbox();
			$('#toClazz').selectMenu({change:changeToClazz});
			
			// 班级options表
			var clazzOptions = {};
			clazzOptions['0'] = '<option value="0">班级（全部）</option>';
			#foreach($c in $clazzList)
				if(clazzOptions['${c.typeid}'] == undefined)
					clazzOptions['${c.typeid}'] = '<option value="0">班级（全部）</option>';
				clazzOptions['${c.typeid}'] +=  '<option value="${c.cid}">${c.name}</option>';
			#end
			
			// 全部
			$('.panel .all').on('click', function(){
				$(this).addClass('active');
				$('#grade').val('0');
				$('#clazz').html('<option value="0">班级（全部）</option>');
				$('#grade').selectMenu({refresh:true,change:changeGrade});
				$('#clazz').selectMenu({refresh:true,change:changeClazz});
				// 页面还原
				toOriginPage();
			});
		
			// 年级联动
			function changeGrade(gradeid){
				$('#grade').val(gradeid);
				$('#clazz').html(clazzOptions[gradeid]);
				$('#clazz').selectMenu({refresh:true,change:changeClazz});
				// 页面还原
				toOriginPage();
				// 筛选处理
				if(gradeid == '0'){
					$('.panel .all').addClass('active');
					$('.listStu .a4').show();
				}else{
					$('.panel .all').removeClass("active");
					$('.listStu .a4').hide();
					$('.listStu .a4[gradeid="'+gradeid+'"]').show();
				}
			}
			
			// 班级联动
			function changeClazz(cid){
				$('#clazz').val(cid);
				// 页面还原
				toOriginPage();
				// 筛选处理
				var gradeid = $('#grade').val();
				if(cid != '0'){
					$('.listStu .a4').hide();
					$('.listStu .a4[cid="'+cid+'"]').show();
				}else if(gradeid != '0'){
					$('.listStu .a4').hide();
					$('.listStu .a4[gradeid="'+gradeid+'"]').show();
				}
			}
		
			// 查看班级详情
			$('.listStu').on('click','.a4 .b1 .c2',function(){
				if($(this).hasClass('active')){
					$(this).removeClass('active');
					$(this).closest('.b1').next().hide();
				}else{
					$(this).addClass('active');
					$(this).closest('.b1').next().show();
					if($(this).closest('.b1').next().children().length==0){
						JH.load.add($(this).attr('data-href'), $(this).closest('.b1').next(), afterloadClazz);
					}
				}
			});
			
			// 加载时，判断整班级选定状态
			function afterloadClazz(b2){
				var checked = $(b2).prev().find('.c1 .checkbox input').attr('checked');
				if(checked){
					$(b2).find('.checkbox').checkbox({checked:true});
				}else{
					$(b2).find('.checkbox').checkbox({checked:false});
				}
			}
			
			// 班级全选
			$('.itemH').on('click', '#classAll', function(){
				if($(this).attr('checked')){
					$('.listStu .a4:visible .checkbox').checkbox({checked:true});
					var num = 0;
					$('.listStu .a4:visible .b1 .c1 .d1').each(function(i,d){
						num += parseInt($(this).text());
					})
					$('#studentNum').text(num);
				}else{
					$('.listStu .a4:visible .checkbox').checkbox({checked:false});
					$('#studentNum').text(0);
				}
			})
			
			// 学生全选
			$('.listStu').on('click','.a4 .b1 .c1 .checkbox input',function(){
				if($(this).attr('checked')){
					$(this).closest('.a4').find('tr:visible .checkbox').checkbox({checked:true});
				}else{
					$(this).closest('.a4').find('tr:visible .checkbox').checkbox({checked:false});
				}
				var num = 0, allchecked = true;
				$('.listStu .a4:visible').each(function(){
					var length = $(this).find('.b2').next().children().length;
					var checked = $(this).find('.b1 .c1 .checkbox input').attr('checked');
					if(length==0 && checked){
						num += parseInt($(this).find('.b1 .c1 .d1').text());
					}else{
						num += $(this).find('tr:visible .checkbox.active').length;
					}
					if(!checked)allchecked = false;
				})
				$('#studentNum').text(num);
				if(allchecked){
					$('#classAll').closest('.checkbox').checkbox({checked:true});
				}else{
					$('#classAll').closest('.checkbox').checkbox({checked:false});
				}
			})
			
			// 学生单个选择
			$('.listStu').on('click','.a4 .b2 .checkbox input',function(){
				var num = parseInt($('#studentNum').text());
				if($(this).attr('checked')){
					num += 1;
				}else{
					num -= 1;
				}
				$('#studentNum').text(num);
				
				var b1_num = parseInt($(this).closest('.a4').find('.b1 .c1 .d1').text());
				var b2_num = $(this).closest('.a4').find('tr:visible .checkbox.active').length;
				if(b2_num < b1_num){
					$(this).closest('.a4').find('.b1 .c1 .checkbox').checkbox({checked:false});
				}else{
					$(this).closest('.a4').find('.b1 .c1 .checkbox').checkbox({checked:true});
				}
				var allchecked = true;
				$('.listStu .a4:visible').each(function(){
					var checked = $(this).find('.b1 .c1 .checkbox input').attr('checked');
					if(!checked)allchecked = false;
				});
				if(allchecked){
					$('#classAll').closest('.checkbox').checkbox({checked:true});
				}else{
					$('#classAll').closest('.checkbox').checkbox({checked:false});
				}
			})
			
			// 调班选项框事件
			function changeToClazz(to_cid){
				$('#toClazz').val(to_cid);
			}
			
			// 调班请求
			$('#classChange').on('click',function(){
				var to_cid = $('#toClazz').val();
				if(to_cid == '0'){
					$.alert({title:'请选择班级！'});
					return false;
				}
				if($('.listStu .a4 .checkbox input:checked').length == 0){
					$.alert({title:'您还未选择学生！'});
					return false;
				}
				
				var cidStr = '', sidStr = '';
				$('.listStu .a4:visible').each(function(){
					if(!$(this).hasClass('q') && 
						$(this).find('.b1 .checkbox input').attr('checked')){
						cidStr += $(this).attr('cid') + ',';
					}else{
						$(this).find('tr:visible').each(function(){
							if($(this).find('.checkbox input').attr('checked')){
								sidStr += $(this).attr('sid') + ',';
							}
						});
					}
				})
				if(cidStr != '')cidStr = cidStr.substr(0, cidStr.length-1);
				if(sidStr != '')sidStr = sidStr.substr(0, sidStr.length-1);
				
				// 上送后台请求
				$.ajax({
					type: "POST",
					url: '${ufbDomain}/school/student_adjustAction.htm',
					data:'toCid='+to_cid+'&cidStr='+cidStr+'&sidStr='+sidStr,
					async:false,
					success: function(data){
						var json = $.parseJSON(data);
						if(json.errCode=='0000'){
							$.alert({title:'调班成功！'});
							location.href = '${ufbDomain}/school/student_adjust.htm?cid='+json.cid;
							return;
						}else{
							$.alert({title:json.errMsg});
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						$.alert({title:'系统出现异常！'});
					}
				});
			})
			
			// 搜索框
			$('.searchDiv span').on('click', function(){
				var value = $('.searchDiv input').val();
				if(value == ''){
					$.alert({title:'请输入学生姓名！'});
					return false;
				}
				// 后台搜索
				var stuList = search_student(value);
				if(stuList.length == 0){
					$.alert({title:'未找到该学生！'});
					return false;
				}
				// 搜索结果，页面展示处理
				$('.panel .all').removeClass('active');
				$('#grade').val('0');
				$('#clazz').html('<option value="0">班级（全部）</option>');
				$('#grade').selectMenu({refresh:true,change:changeGrade});
				$('#clazz').selectMenu({refresh:true,change:changeClazz});
				
				$('.listStu .a4').hide();
				$('.listStu .a4').each(function(){
					var cid = $(this).attr('cid');
					if(inClazz(cid, stuList)){
						// 展示班级
						$(this).addClass('q');
						$(this).show();
						// 加载学生列表
						var c2 = $(this).find('.b1 .c2');
						if(!c2.hasClass('active')){
							c2.addClass('active');
							c2.closest('.b1').next().show();
							if(c2.closest('.b1').next().children().length==0){
								JH.load.syncAdd(c2.attr('data-href'), c2.closest('.b1').next());
							}
						}
						// 学生列表处理
						$(this).find('tr').hide();
						$(this).find('tr').each(function(){
							var sid = $(this).attr('sid');
							if(sid == undefined){     // 学生表头
								$(this).show();
							}else if(inStudent(sid, stuList)){   // 学生结果
								$(this).show();
							}
						});
						// 记录数量
						var num = $(this).find('tr:visible').length-1;
						$(this).find('.b1 .c1 .d1').text(num);
					}
				});
			});
			
			function inClazz(cid, stuList){
				for(var i = 0; i < stuList.length; i++){
					if(stuList[i].cid == cid){
						return true;
					}
				}
				return false;
			}
			
			function inStudent(sid, stuList){
				for(var i = 0; i < stuList.length; i++){
					if(stuList[i].sid == sid){
						return true;
					}
				}
				return false;
			}
			
			function search_student(queryStr){
				var result = [];
				$.ajax({
					type: "POST",
					url: '${ufbDomain}/school/student_search.htm',
					data:'name='+queryStr,
					async:false,
					success: function(data){
						var json = $.parseJSON(data);
						if(json.errCode=='0000'){
							result = json.students;
						}else{
							$.alert({title:json.errMsg});
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						$.alert({title:'系统出现异常！'});
					}
				});
				return result;
			}
			
			// 搜索后，页面重置
			function toOriginPage(){
				// 搜索框
				$('.searchDiv input').val('');
				// 搜索结果影响还原
				$('.listStu .a4.q').each(function(){
					var num = $(this).find('.b2 tr').length -1;
					$(this).find('.b1 .c1 .d1').text(num);
				});
				$('.listStu .a4.q').removeClass('q');
				$('.listStu tr:hidden').show();
				// 班级展开部分还原
				$('.listStu .a4 .b1 .c2').each(function(){
					if($(this).hasClass('active')){
						$(this).removeClass('active');
						$(this).closest('.b1').next().hide();
					}
				});
				// 展示全部班级
				$('.listStu .a4:hidden').show();
				$('.checkbox').checkbox();
				$('#studentNum').text('0');
			}
			
			function removeStudent(sid){
				var result = false;
				$.ajax({
					type: "POST",
					url: '${ufbDomain}/school/student_remove.htm',
					data:'sid='+sid,
					async:false,
					success: function(data){
						var json = $.parseJSON(data);
						if(json.errCode=='0000'){
							$.alert({title:'删除成功！'});
							result = true;
						}else{
							$.alert({title:json.errMsg});
						}
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						$.alert({title:'系统出现异常！'});
					}
				});
				return result;
			}
		</script>
		<!--结束 本页面JS-->
	</section>
	<!--结束 body内容替换区域-->
</div>